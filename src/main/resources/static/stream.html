<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HLS Video Player</title>
    <link href="https://vjs.zencdn.net/7.11.4/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/7.11.4/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
<h1>Stream Video</h1>
<video id="video" class="video-js vjs-default-skin" controls preload="auto" width="640" height="264" muted></video>
<div id="currentTimeDisplay">Current Time: 0</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const videoPath = '/video/good.m3u8';
        const video = document.getElementById('video');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');



            let hls = new Hls({
                maxFragLookUpTolerance: 0.2,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                maxBufferSize: 60 * 1000 * 1000,
                maxBufferHole: 0.5,
                maxSeekHole: 0.1,
                startFragPrefetch: true,
                lowLatencyMode: true,
                backBufferLength: 10,
                liveSyncDurationCount: 3,
                liveMaxLatencyDurationCount: 5,
                enableWorker: true,
                fragLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 6,
                fragLoadingRetryDelay: 1000,
                fragLoadingMaxRetryTimeout: 64000
            });
            hls.loadSource(videoPath);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                console.log('Manifest parsed, start loading...');
                video.play();
            });

            hls.on(Hls.Events.FRAG_BUFFERED, function(event, data) {
                console.log(`Fragment ${data.frag.sn} buffered`);
            });

            hls.on(Hls.Events.ERROR, function(event, data) {
                console.error('HLS.js error:', data);
                if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                    if (data.details === Hls.ErrorDetails.BUFFER_STALLED_ERROR) {
                        console.log('Buffer stalled error occurred, attempting to recover...');
                        hls.recoverMediaError();
                    }
                }
            });

            video.addEventListener('timeupdate', function() {
                currentTimeDisplay.innerText = 'Current Time: ' + video.currentTime.toFixed(2);
            });

            video.addEventListener('seeking', function() {
                console.log('seeking 시작됨');
                handleSeeking(video.currentTime);
            });

            function handleSeeking(currentTime) {
                const levelDetails = hls.levels[hls.currentLevel].details;
                const fragments = levelDetails.fragments;
                const targetFrag = fragments.find(frag => currentTime >= frag.start && currentTime < frag.end);

                if (targetFrag) {
                    const targetFragIndex = targetFrag.sn;
                    console.log(`Target fragment index: ${targetFragIndex}`);

                    // 필요한 프래그먼트만 로드
                    hls.stopLoad();
                    hls.config.startPosition = currentTime;
                    hls.loadLevel = hls.currentLevel;
                    hls.startLoad(targetFrag.start);
                }
            }

    });
</script>
</body>
</html>
